// Prisma schema for DevOps Roadmap App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  name        String
  createdAt   DateTime  @default(now())
  currentWeek Int       @default(1)
  totalXP     Int       @default(0)

  progress     Progress[]
  projects     Project[]
  badges       Badge[]
  labSessions  LabSession[]
  aars         AfterActionReview[]
  certifications Certification[]
  recertificationAttempts RecertificationAttempt[]
}

model Progress {
  id          String    @id @default(cuid())
  userId      String
  weekId      Int
  lessonId    String
  completed   Boolean   @default(false)
  score       Int?
  completedAt DateTime?
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, weekId, lessonId])
}

model Project {
  id          String    @id @default(cuid())
  userId      String
  projectId   String    // "project-1", "project-2", "project-3"
  title       String
  description String?
  githubUrl   String?
  deployUrl   String?
  completed   Boolean   @default(false)
  completedAt DateTime?
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, projectId])
}

model Badge {
  id          String    @id @default(cuid())
  userId      String
  badgeType   String    // "linux-explorer", "git-master", etc.
  badgeName   String
  earnedAt    DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LabSession {
  id          String    @id @default(cuid())
  userId      String
  exerciseId  String    // "lab-1", "lab-2", etc.
  code        String?   // User's submitted code
  output      String?   // Lab output/result
  passed      Boolean   @default(false)
  submittedAt DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AfterActionReview {
  id          String    @id @default(uuid())
  userId      String
  lessonId    String
  level       String    // "crawl", "walk", "run-guided", "run-independent"
  labId       String    // specific lab/exercise identifier
  completedAt DateTime

  // Required AAR fields
  whatWasAccomplished    String
  whatWorkedWell         Json      // JSON array of strings
  whatDidNotWork         Json      // JSON array of strings
  whyDidNotWork          String
  whatWouldIDoDifferently String
  whatDidILearn          String

  // Metadata
  wordCounts   Json      // JSON object with word counts
  qualityScore Float?    // AI-calculated quality score (1-10)

  // AI analysis
  aiReview     Json?     // JSON object with AI review data
  patterns     Json?     // JSON array of detected patterns

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Certification {
  id                    String    @id @default(uuid())
  userId                String
  skillId               String    // "docker-basics", "kubernetes-fundamentals", etc.
  certificationLevel    String    // "bronze", "silver", "gold", "platinum", "master"
  earnedAt              DateTime  @default(now())
  expiresAt             DateTime
  lastRecertifiedAt     DateTime  @default(now())
  recertificationRequired Boolean @default(false)
  gracePeriodDays       Int       @default(30)
  consecutivePasses     Int       @default(1)
  totalAttempts         Int       @default(1)

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  attempts              RecertificationAttempt[]

  @@unique([userId, skillId])
}

model RecertificationAttempt {
  id                    String    @id @default(uuid())
  userId                String
  certificationId       String
  drillId               String    // "docker-basics-bronze-1", etc.
  score                 Int       // 0-100
  passed                Boolean
  timeSpentMinutes      Float
  completedAt           DateTime  @default(now())

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  certification         Certification @relation(fields: [certificationId], references: [id], onDelete: Cascade)
}
