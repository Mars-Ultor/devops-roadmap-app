name: Performance Monitoring

on:
  schedule:
    # Run weekly on Wednesdays at 9 AM UTC
    - cron: '0 9 * * 3'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'client/**'
      - '.lighthouserc.json'
  push:
    branches: [ master, main ]
    paths:
      - 'client/**'
      - '.lighthouserc.json'
  workflow_dispatch:

jobs:
  lighthouse-audit:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build client for audit
        run: |
          cd client
          npm ci
          npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_ML_API_URL: ${{ secrets.VITE_ML_API_URL }}

      - name: Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to temporary Firebase channel
        id: deploy
        run: |
          cd client
          # Deploy to temporary channel and capture the URL
          DEPLOY_OUTPUT=$(firebase hosting:channel:deploy temp-audit-${{ github.run_id }} --expires 2h --token ${{ secrets.FIREBASE_TOKEN }})
          CHANNEL_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.web\.app' | head -1)
          echo "url=$CHANNEL_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $CHANNEL_URL"

      - name: Wait for deployment to be ready
        run: |
          URL="${{ steps.deploy.outputs.url }}"
          echo "Waiting for $URL to be ready..."
          for i in {1..30}; do
            if curl -s --head --fail "$URL" > /dev/null 2>&1; then
              echo "Site is ready!"
              break
            fi
            echo "Attempt $i: Site not ready yet, waiting..."
            sleep 10
          done

      - name: Run Lighthouse audit
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: ${{ steps.deploy.outputs.url }}
          configPath: .lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Format results
        run: |
          echo "## Lighthouse Performance Results" >> performance-report.md
          echo "" >> performance-report.md
          echo "### Scores:" >> performance-report.md
          echo "- Performance: ${{ steps.lighthouse.outputs.performance }}" >> performance-report.md
          echo "- Accessibility: ${{ steps.lighthouse.outputs.accessibility }}" >> performance-report.md
          echo "- Best Practices: ${{ steps.lighthouse.outputs.best-practices }}" >> performance-report.md
          echo "- SEO: ${{ steps.lighthouse.outputs.seo }}" >> performance-report.md
          echo "" >> performance-report.md
          echo "### URL: ${{ steps.deploy.outputs.url }}" >> performance-report.md
          echo "### Date: $(date -Iseconds)" >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: performance-report.md
          retention-days: 30

      - name: Check performance thresholds
        id: check-threshold
        run: |
          PERFORMANCE=${{ steps.lighthouse.outputs.performance }}
          ACCESSIBILITY=${{ steps.lighthouse.outputs.accessibility }}
          BEST_PRACTICES=${{ steps.lighthouse.outputs.best-practices }}
          SEO=${{ steps.lighthouse.outputs.seo }}

          echo "Performance score: $PERFORMANCE"
          echo "Accessibility score: $ACCESSIBILITY"
          echo "Best Practices score: $BEST_PRACTICES"
          echo "SEO score: $SEO"

          # Check if scores are below thresholds (using awk for floating point comparison)
          PERFORMANCE_THRESHOLD=80
          ACCESSIBILITY_THRESHOLD=90
          BEST_PRACTICES_THRESHOLD=90
          SEO_THRESHOLD=90

          if awk "BEGIN {exit !($PERFORMANCE < $PERFORMANCE_THRESHOLD)}"; then
            echo "performance_below_threshold=true" >> $GITHUB_OUTPUT
          fi

          if awk "BEGIN {exit !($ACCESSIBILITY < $ACCESSIBILITY_THRESHOLD)}"; then
            echo "accessibility_below_threshold=true" >> $GITHUB_OUTPUT
          fi

          if awk "BEGIN {exit !($BEST_PRACTICES < $BEST_PRACTICES_THRESHOLD)}"; then
            echo "best_practices_below_threshold=true" >> $GITHUB_OUTPUT
          fi

          if awk "BEGIN {exit !($SEO < $SEO_THRESHOLD)}"; then
            echo "seo_below_threshold=true" >> $GITHUB_OUTPUT
          fi

      - name: Create performance issue
        if: steps.check-threshold.outputs.performance_below_threshold == 'true' || steps.check-threshold.outputs.accessibility_below_threshold == 'true' || steps.check-threshold.outputs.best_practices_below_threshold == 'true' || steps.check-threshold.outputs.seo_below_threshold == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const performance = ${{ steps.lighthouse.outputs.performance }};
            const accessibility = ${{ steps.lighthouse.outputs.accessibility }};
            const bestPractices = ${{ steps.lighthouse.outputs.best-practices }};
            const seo = ${{ steps.lighthouse.outputs.seo }};

            const title = `ðŸ“Š Performance Alert: Scores Below Threshold`;
            const body = `
            ## ðŸš¨ Performance Audit Results

            ### Current Scores:
            - **Performance:** ${performance}/100 ${performance < 80 ? 'âŒ' : 'âœ…'}
            - **Accessibility:** ${accessibility}/100 ${accessibility < 90 ? 'âŒ' : 'âœ…'}
            - **Best Practices:** ${bestPractices}/100 ${bestPractices < 90 ? 'âŒ' : 'âœ…'}
            - **SEO:** ${seo}/100 ${seo < 90 ? 'âŒ' : 'âœ…'}

            ### Thresholds:
            - Performance: â‰¥80 (currently ${performance < 80 ? 'failing' : 'passing'})
            - Accessibility: â‰¥90 (currently ${accessibility < 90 ? 'failing' : 'passing'})
            - Best Practices: â‰¥90 (currently ${bestPractices < 90 ? 'failing' : 'passing'})
            - SEO: â‰¥90 (currently ${seo < 90 ? 'failing' : 'passing'})

            ### Actions Required:
            1. Review the Lighthouse report in workflow artifacts
            2. Optimize performance issues (bundle size, images, caching)
            3. Fix accessibility problems (alt text, contrast, keyboard navigation)
            4. Address best practices violations (HTTPS, security headers)
            5. Improve SEO (meta tags, structured data, performance)
            6. Test on staging before production deployment

            ### Audit Details:
            - **Audit Date:** ${new Date().toISOString()}
            - **Repository:** ${{ github.repository }}
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            - **URL:** ${{ steps.deploy.outputs.url }}
            - **Workflow:** ${{ github.workflow }}
            - **Run ID:** ${{ github.run_id }}

            ### Performance Budgets:
            - First Contentful Paint (FCP): < 1.8s
            - Largest Contentful Paint (LCP): < 2.5s
            - Time to Interactive (TTI): < 3.8s
            - Total Blocking Time (TBT): < 200ms
            - Cumulative Layout Shift (CLS): < 0.1

            ---
            ðŸ¤– This issue was automatically created by the performance monitoring workflow.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['performance', 'accessibility', 'monitoring', 'lighthouse']
            });

      - name: Send Slack notification
        if: steps.check-threshold.outputs.performance_below_threshold == 'true' || steps.check-threshold.outputs.accessibility_below_threshold == 'true' || steps.check-threshold.outputs.best_practices_below_threshold == 'true' || steps.check-threshold.outputs.seo_below_threshold == 'true'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ðŸš¨ Performance Alert: DevOps Roadmap App",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ“Š Performance Alert: Scores Below Threshold"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Performance:* ${{ steps.lighthouse.outputs.performance }}/100 ${{ fromJSON(steps.check-threshold.outputs.performance_below_threshold) && 'âŒ' || 'âœ…' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Accessibility:* ${{ steps.lighthouse.outputs.accessibility }}/100 ${{ fromJSON(steps.check-threshold.outputs.accessibility_below_threshold) && 'âŒ' || 'âœ…' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Best Practices:* ${{ steps.lighthouse.outputs.best-practices }}/100 ${{ fromJSON(steps.check-threshold.outputs.best_practices_below_threshold) && 'âŒ' || 'âœ…' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*SEO:* ${{ steps.lighthouse.outputs.seo }}/100 ${{ fromJSON(steps.check-threshold.outputs.seo_below_threshold) && 'âŒ' || 'âœ…' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*URL:* ${{ steps.deploy.outputs.url }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* `${{ github.sha }}`"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Issue"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Lighthouse Report"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report-${{ github.run_id }}
          path: .lighthouseci/
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const performance = ${{ steps.lighthouse.outputs.performance }};
            const accessibility = ${{ steps.lighthouse.outputs.accessibility }};
            const bestPractices = ${{ steps.lighthouse.outputs.best-practices }};
            const seo = ${{ steps.lighthouse.outputs.seo }};

            const comment = `
            ## ðŸ“Š Lighthouse Performance Audit Results

            ### Scores:
            - **Performance:** ${performance}/100 ${performance < 80 ? 'âŒ' : 'âœ…'}
            - **Accessibility:** ${accessibility}/100 ${accessibility < 90 ? 'âŒ' : 'âœ…'}
            - **Best Practices:** ${bestPractices}/100 ${bestPractices < 90 ? 'âŒ' : 'âœ…'}
            - **SEO:** ${seo}/100 ${seo < 90 ? 'âŒ' : 'âœ…'}

            ### Thresholds:
            - Performance: â‰¥80 ${performance < 80 ? '(failing)' : '(passing)'}
            - Accessibility: â‰¥90 ${accessibility < 90 ? '(failing)' : '(passing)'}
            - Best Practices: â‰¥90 ${bestPractices < 90 ? '(failing)' : '(passing)'}
            - SEO: â‰¥90 ${seo < 90 ? '(failing)' : '(passing)'}

            ${performance < 80 || accessibility < 90 || bestPractices < 90 || seo < 90 ?
              'âš ï¸ **Some scores are below thresholds.** Please review the performance issues.' :
              'âœ… **All scores meet or exceed thresholds.** Great job!'}

            ðŸ“ˆ [View detailed Lighthouse report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)

            ---
            ðŸ¤– This comment was automatically generated by the performance monitoring workflow.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });