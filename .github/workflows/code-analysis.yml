name: Code Analysis

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  analysis:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install frontend dependencies
      run: |
        cd client
        npm ci

    - name: Install backend dependencies
      run: |
        cd server
        npm ci

    - name: Install ML service dependencies
      run: |
        cd ml-service
        pip install -r requirements.txt

    - name: Run ESLint (Frontend)
      run: |
        cd client
        npm run lint

    - name: Run ESLint (Backend)
      run: |
        cd server
        npm run lint

    - name: Run TypeScript checks
      run: |
        cd client
        npx tsc --noEmit
        cd ../server
        npx tsc --noEmit

    - name: Run Python linting
      run: |
        cd ml-service
        python -m flake8 . --max-line-length=88 --extend-ignore=E203,W503

    - name: Run tests with coverage
      run: |
        cd client
        npm run test:coverage
        cd ../server
        npm run test:coverage
        cd ../ml-service
        python -m pytest --cov=. --cov-report=xml

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./client/coverage/lcov.info,./server/coverage/lcov.info,./ml-service/coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --file=client/package.json --sarif-file-output=snyk-frontend.sarif

    - name: Upload Snyk results to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: snyk-frontend.sarif

    - name: SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@v1
      continue-on-error: true
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    - name: Build frontend
      run: |
        cd client
        npm run build

    - name: Build backend
      run: |
        cd server
        npm run build

    - name: Performance check (Lighthouse)
      run: |
        npm install -g lighthouse
        cd client
        npx serve -s dist -l 3000 &
        sleep 10
        lighthouse http://localhost:3000 --output json --output-path ../reports/lighthouse.json || true
        pkill -f serve || true

    - name: Archive analysis results
      uses: actions/upload-artifact@v3
      with:
        name: analysis-results-${{ matrix.node-version }}
        path: |
          reports/
          client/coverage/
          server/coverage/
          ml-service/coverage.xml
<parameter name="filePath">c:\Users\ayode\Desktop\devops-roadmap-app\.github\workflows\code-analysis.yml
